head	1.2;
access;
symbols;
locks
	george:1.2; strict;
comment	@# @;


1.2
date	2010.08.26.07.08.04;	author george;	state Exp;
branches;
next	1.1;

1.1
date	2010.08.26.03.53.28;	author george;	state Exp;
branches;
next	;


desc
@@


1.2
log
@*** empty log message ***
@
text
@#!/usr/local/bin/ruby   
class Typho
require 'rubygems'
require 'json'
require 'typhoeus'


  def initialize 
   @@cart_items = [
            {:song_name=>"the Desert Moon", :id => 1, :price => 12, :qty => 3},
            {:song_name=>"Hymalayan winds ", :id => 2, :price => 1, :qty => 3}, 
            {:song_name=>"Pine away", :id => 3, :price => 1, :qty => 3},
           ]
   @@uri = 'http://localhost:3000'
   @@session = Hash.new
   @@session[:cart] = @@cart_items.to_json
  end
# 
  def re_key 
   @@order_items = JSON.parse @@session[:cart]
   @@api_key = get_single_access_token 'wala', '1234', @@uri, 142
   @@session[:api_key] = @@api_key
   puts @@api_key
  end
#
  def create
     items = JSON.parse @@session[:cart]
     sum = items.inject(0.0){ |sum, i| sum + i['price'].to_f * i['qty'].to_f }
     order = {
               :memo => @@session[:cart], 
               :order_type => 'checkout',
               :sum_total => sum,
               :mobile => '9196095443',
               :pin => '1234'
             }
   result = create_order(order, "localhost:3000")
   @@order_id = result['id']
   puts "Order_id = #{@@order_id}"
  end
 #  
 def show
   url = 'localhost:3000'
      r = Typhoeus::Request.get("http://#{url}/orders/#{@@order_id}.json",
                   :params => { :user_credentials => @@session[:api_key]})
   result = JSON.parse r.body
   puts result
   @@order = result["order"]
  puts @@order
 end 
 #
 def execute
  puts "Enter buyer_code:"
  p_code = gets.chomp 
  r = Typhoeus::Request.put("#{@@uri}/orders/#{@@order_id}/execute.json",
                   :params => {:buy_code => p_code , :user_credentials => @@session[:api_key]})
   result = parse_response r
   puts "execute result= #{result['status']}"
 end
  
 private
 # 
 #
  def create_order order, url
   api_key = @@session[:api_key]
   r = Typhoeus::Request.post("http://localhost:3000/orders.json",
                   :params => { :checkout => order, :order_type=> 'checkout', :user_credentials => api_key})
   parse_response r
  end
 # 
  def get_single_access_token nickname, password, server_url, user_id
      auth = {:username => nickname, #|| "wala", #terminal username
              :password => password, #|| "1234", #terminal pin number
              :method => Typhoeus::Easy::AUTH_TYPES[:CURLAUTH_DIGEST]}

           headers = {"Accept"=>'application/json,text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'}
           url = "http://#{server_url}/users/#{user_id}/rekey.json"
           api_key = 'Initial Value'
           e = Typhoeus::Easy.new
           e.auth, e.url, e.headers = auth, "http://localhost:3000/users/142/rekey.json", headers
           e.on_success { api_key = e.response_body }
           Typhoeus.add_easy_request(e)
           Typhoeus.perform_easy_requests 
           return api_key
  end 
 #
 # 
  def parse_response r
  puts 'response.body: #{r.body}'
  r.code == 200 ? JSON.parse(r.body) : r.body
  end
end
while true
   typho = Typho.new
   typho.re_key

   puts "Hit enter to create order:"
   gets
   typho.create

   puts "Hit enter to show order:"
   gets
   typho.show

   #typho.execute
end
@


1.1
log
@Initial revision
@
text
@d14 1
d21 1
a21 1
   @@api_key = get_single_access_token 'wala', '1234', 'localhost:3000', 142
d53 2
a54 2
  p_code = gets.chomp! 
  r = Typhoeus::Request.put("http://localhost:3000/orders/#{@@order_id}/execute.json",
d57 1
a57 1
   puts "execute result= #{result}"
d88 1
a88 1
  puts "raw return: #{r}"
d92 1
a92 1

d104 2
a105 4
   puts "Hit enter to execute:"
   gets
   typho.execute

@
